<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Lomse library. API documentation: Scores playback overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="lomse.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_100x195.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Lomse library. API documentation
   &#160;<span id="projectnumber">0.18.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Overview</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="modules.html"><span>Types&#160;and&#160;constants</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li class="current"><a href="pages.html"><span>Other</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('sound-generation.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Scores playback overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#sound-generation-overview">How Lomse playback works</a></li>
<li class="level1"><a href="#playback-summary">Your application set-up: summary</a></li>
<li class="level1"><a href="#handling-sound-events">How to handle sound events</a></li>
<li class="level1"><a href="#how-to-play-score">How to play an score</a></li>
<li class="level1"><a href="#handling-highlight-events">Handling highlight events</a></li>
<li class="level1"><a href="#implementing-player-gui">The PlayerGui object</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="sound-generation-overview"></a>
How Lomse playback works</h1>
<p>Lomse is platform independent code and cannot generate sounds for your specific platform. Therefore, lomse implements playback by generating real-time events and sending them to your application. It is responsibility of your application to handle these events and do whatever is needed, i.e. transform sound events into real sounds or doing whatever you would like with the sound events.</p>
<p>From Lomse internal point of view, playing back an score involves, basically, two steps:</p>
<ul>
<li>The score internal model is parsed to build the sound model.</li>
<li>The sound model is then traversed and three kind of events are generated:<ol type="1">
<li>Sound events, for generating sounds.</li>
<li>Highlight events, for adding visual tracking effects to the displayed score. For instance, highlighting notes as they are being played or displaying a vertical line at current beat position.</li>
<li>End of playback events, oriented to facilitate GUI controls synchronization and housekeeping.</li>
</ol>
</li>
</ul>
<p>It is responsibility of your application to handle these events and do whatever is necessary. But for visual effects, lomse provides an implementation for generating them so, if desired, your application can delegate in lomse for this task.</p>
<h1><a class="anchor" id="playback-summary"></a>
Your application set-up: summary</h1>
<p>For playing back an score your application has to:</p>
<ul>
<li>Define a class, derived from <code>MidiServerBase</code>. This class will receive the sound events and will have the responsibility for generating the sounds. See <a class="el" href="sound-generation.html#handling-sound-events">How to handle sound events</a>.</li>
<li><p class="startli">Create an instance of class <code>ScorePlayer</code>. This class takes care of most of the work to do. By using it, playing an score is just two tasks:</p>
<ol type="1">
<li>Load the score to play in the <code>ScorePlayer</code> instance.</li>
<li>Ask <code>ScorePlayer</code> to play it, specifying the desired options (i.e. visual tracking, metronome settings, count-off, etc).</li>
</ol>
<p class="startli">See <a class="el" href="sound-generation.html#how-to-play-score">How to play an score</a>.</p>
</li>
<li>Deal with <em>highlight</em> events. All <em>highlight</em> events will be sent to the standard callback for events. For processing them, your application could delegate in Lomse by invoking method Interactor::on_highlight_event(). See <a class="el" href="sound-generation.html#handling-highlight-events">Handling highlight events</a>.</li>
<li>Optionally, you should create a class derived from "PlayerGui". This will allow you to link your application playback controls to lomse, so that lomse can collect current settings when needed. See <a class="el" href="sound-generation.html#implementing-player-gui">The PlayerGui object</a>.</li>
</ul>
<p>As you can see, implementing score playback in an application is not complex, and the only burden for your application is coding a <code>MidiServer</code> class for generating the sounds.</p>
<h1><a class="anchor" id="handling-sound-events"></a>
How to handle sound events</h1>
<p>For playing back an score your application has just to define a class, derived from MidiServerBase. This class defines the interface for processing sound events. Your application has to define a derived class (i.e. <code>MyMidiServer</code>) and implement the following virtual methods:</p>
<div class="fragment"><div class="line"><span class="keyword">virtual</span> <span class="keywordtype">void</span> program_change(<span class="keywordtype">int</span> channel, <span class="keywordtype">int</span> instr) {}</div>
<div class="line"><span class="keyword">virtual</span> <span class="keywordtype">void</span> voice_change(<span class="keywordtype">int</span> channel, <span class="keywordtype">int</span> instr) {}</div>
<div class="line"><span class="keyword">virtual</span> <span class="keywordtype">void</span> note_on(<span class="keywordtype">int</span> channel, <span class="keywordtype">int</span> pitch, <span class="keywordtype">int</span> volume) {}</div>
<div class="line"><span class="keyword">virtual</span> <span class="keywordtype">void</span> note_off(<span class="keywordtype">int</span> channel, <span class="keywordtype">int</span> pitch, <span class="keywordtype">int</span> volume) {}</div>
<div class="line"><span class="keyword">virtual</span> <span class="keywordtype">void</span> all_sounds_off() {}</div>
</div><!-- fragment --><p>Sound events will be sent, directly, to your <code>MyMidiServer</code> class just by invoking any of the virtual methods. Invocation of these methods is done in real time, that is, lomse will determine the exact time at which a note on / note off has to take place, and will invoke the respective method, <code>note_on()</code> or <code>note_off()</code>, at the appropriate time. This implies that your midi server implementation is only responsible for generating or stopping sounds when requested, and no time computations are needed.</p>
<p>Lomse does not impose any restriction about how to generate sounds other than low latency. Perhaps, the simpler method to generate sounds is to rely on the MIDI synthesizer of the PC sound card.</p>
<dl class="section attention"><dt>Attention</dt><dd>As playback is a real-time task, your code must return quickly. If it needs to do some significant amount of work then you must schedule this work asynchronously, for example by posting a windows message, or you should use a separate thread. Your application should not retain control for much time as this would result in freezing lomse playback thread.</dd></dl>
<h1><a class="anchor" id="how-to-play-score"></a>
How to play an score</h1>
<p>Class ScorePlayer provides the necessary methods for controlling all playback (start, stop, pause, etc.). Your application will have to request lomse the instance of ScorePlayer by invoking <a class="el" href="classLomseDoorway.html#a50dbce970b84945868887966a0708634">LomseDoorway::create_score_player()</a> method and passing the <code>MidiServer</code> to use:</p>
<div class="fragment"><div class="line">MyAppMidiServer* pMidi = <span class="keyword">new</span> MyAppMidiServer();</div>
<div class="line">ScorePlayer* pPlayer = m_lomse-&gt;<a class="code" href="classLomseDoorway.html#a50dbce970b84945868887966a0708634">create_score_player</a>(pMidi);</div>
</div><!-- fragment --><p>This can be done only once if your application saves the ScorePlayer instance in a global variable and ensures the appropriate life scope for your <code>MyAppMidiServer</code> object.</p>
<p>Once you have the ScorePlayer instance, playback is just loading the score to play (by invoking ScorePlayer::load_score() method) and invoking the appropriate methods, such as ScorePlayer::play() or ScorePlayer::stop() or ScorePlayer::pause();</p>
<p>The only tricky issue, when starting to learn how to use lomse, is that method ScorePlayer::load_score() requires a pointer to the score to play. How to do get this pointer depends on your application, but a simple way of doing it is by using the Document methods for traversing the document and accessing its components. One of these methods is Document::get_content_item() that takes as argument the index to the desired content item. For instance:</p>
<div class="fragment"><div class="line"><span class="comment">//get the score player you have set up for your application</span></div>
<div class="line">ScorePlayer* pPlayer  = myAppGlobals-&gt;get_score_player();</div>
<div class="line"></div>
<div class="line"><span class="comment">//get the first score</span></div>
<div class="line">ImoScore* pScore = NULL;</div>
<div class="line"><span class="keywordtype">int</span> i = 0;</div>
<div class="line"><span class="keywordflow">while</span> (<span class="keyword">true</span>)</div>
<div class="line">{</div>
<div class="line">    ImoObj* pObj = pDocument-&gt;get_content_item(i);</div>
<div class="line">    <span class="keywordflow">if</span> (pObj == NULL)   <span class="comment">//end of document!</span></div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">if</span> (pObj-&gt;is_score())</div>
<div class="line">    {</div>
<div class="line">        pScore = <span class="keyword">static_cast&lt;</span>ImoScore*<span class="keyword">&gt;</span>(pObj);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    ++i;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//load the score and start playback</span></div>
<div class="line"><span class="keywordflow">if</span> (pScore)</div>
<div class="line">{</div>
<div class="line">    pPlayer-&gt;load_score(pScore, NULL);</div>
<div class="line"></div>
<div class="line">    <span class="comment">//settings for playback. Probably you would get settings from GUI controls</span></div>
<div class="line">    <span class="keywordtype">bool</span> fVisualTracking = <span class="keyword">true</span>;    <span class="comment">//generate visual tracking effects</span></div>
<div class="line">    <span class="keywordtype">bool</span> fCountOff = <span class="keyword">false</span>          <span class="comment">//no count off before start play</span></div>
<div class="line">    <span class="keywordtype">long</span> nMM = 60;                  <span class="comment">//beats per minute</span></div>
<div class="line">    <a class="code" href="classInteractor.html">Interactor</a>* pInteractor = ...   <span class="comment">//get the interactor for this document</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">//start playback</span></div>
<div class="line">    pPlayer-&gt;play(fVisualTracking, fCountOff, k_play_normal_instrument, nMM, pInteractor);</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000004">Todo:</a></b></dt><dd>Check example code: pPlayer-&gt;play(fVisualTracking, fCountOff, k_play_normal_instrument, nMM, pInteractor);</dd></dl>
<h1><a class="anchor" id="handling-highlight-events"></a>
Handling highlight events</h1>
<p>Apart from generating sound events, lomse also generates <em>highlight</em> events, that is, events to add visual tracking effects, synchronized with sound, on the displayed score.</p>
<p>For generating visual effects you have two options, either do it yourself by modifying the lomse graphical model as desired or, simpler, delegate in lomse for generating standard visual effects. Lomse offers two type of visual effects:</p>
<ul>
<li>Coloring notes as they are being played. This is currently fully operational.</li>
<li>Displaying a vertical colored tempo line across the system, positioned at current beat. This is not yet finished and, therefore, is not yet available.</li>
</ul>
<p><em>Highlight</em> events are sent to your application via the event handling callback, that you set up at Lomse initialization. When handling a <em>highlight</em> event, if your application would like to delegate in Lomse for visual effects generation, the only thing to do is to pass the event to the interactor:</p>
<div class="fragment"><div class="line">pInteractor-&gt;handle_event(pEvent);</div>
</div><!-- fragment --><p>Lomse will handle the event and will send an <em>update window</em> event to your application, for updating the display.</p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000005">Todo:</a></b></dt><dd>Advanced topic: direct modification of the graphic model.</dd></dl>
<h1><a class="anchor" id="implementing-player-gui"></a>
The PlayerGui object</h1>
<p>For controlling playback some GUI controls (buttons, menu items, etc. to trigger start, stop, pause actions, sliders or other for setting tempo speed, etc.) are normally required.</p>
<p>The simplest way for passing the value of a playback option (i.e. the tempo speed) is to pass the value directly to lomse when asking to play the score in method ScorePlayer::play(). But this approach has a drawback: if the user changes, for instance, the tempo slider, lomse will not be informed of the change.</p>
<p>For solving these kind of problems, the solution is to link your application playback controls to lomse, so that lomse can be informed when changes take place or can collect current settings when needed. For doing this linking your application will have to define a class derived from PlayerGui (it can be your main window) and implement a few virtual methods to allow lomse to access the current values of your application playback controls:</p>
<div class="fragment"><div class="line"><span class="keyword">virtual</span> <span class="keywordtype">int</span> get_play_mode() = 0;</div>
<div class="line"><span class="keyword">virtual</span> <span class="keywordtype">int</span> get_metronome_mm() = 0;</div>
<div class="line"><span class="keyword">virtual</span> Metronome* get_metronome() = 0;</div>
<div class="line"><span class="keyword">virtual</span> <span class="keywordtype">bool</span> countoff_status() = 0;</div>
<div class="line"><span class="keyword">virtual</span> <span class="keywordtype">bool</span> metronome_status() = 0;</div>
<div class="line"><span class="keyword">virtual</span> <span class="keywordtype">void</span> on_end_of_playback() = 0;</div>
</div><!-- fragment --><p>The implementation of these methods is usually as simple as linking each method to the appropriate control in your application. For instance:</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> MainWindow::countoff_status()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> GetMenuBar()-&gt;IsChecked(k_menu_play_countoff);</div>
<div class="line">}</div>
</div><!-- fragment --><p>PlayerGui is also the object that will receive <em>end of playback events</em>. These are events generated by lomse for signaling the end of playback, so that your application can restore GUI controls related to playback or do other things. This event is sent <b>simultaneously</b> to your application by to mechanisms:</p>
<ul>
<li>Via the event handling callback, set up at Lomse initialization, and</li>
<li>by invoking method PlayerGui::on_end_of_play_back() if a PlayerGui was set when loading the score.</li>
</ul>
<p>If you look at example code in section <a class="el" href="sound-generation.html#how-to-play-score">How to play an score</a> (relevant lines duplicated here):</p>
<div class="fragment"><div class="line"><span class="comment">//load the score and start playback</span></div>
<div class="line"><span class="keywordflow">if</span> (pScore)</div>
<div class="line">{</div>
<div class="line">    pPlayer-&gt;load_score(pScore, NULL);</div>
</div><!-- fragment --><p>the second parameter for load_score is NULL, meaning that no PlayerGui is used. As you can deduce, the way of informing lomse of the GUI proxy to use is by passing a pointer to the PlayerGui in this method:</p>
<div class="fragment"><div class="line"><span class="comment">//get your PlayerGui object</span></div>
<div class="line">MyPlayerGui* pGui = ... </div>
<div class="line"></div>
<div class="line"><span class="comment">//load the score and link playback options to your MyPlayerGui object</span></div>
<div class="line">pPlayer-&gt;load_score(pScore, pGui);</div>
<div class="line"></div>
<div class="line"><span class="comment">//setting tempo to 0 forces lomse to use the tempo returned by your MyPlayerGui object.</span></div>
<div class="line"><span class="comment">//a value different from 0 forces lomse to use that tempo</span></div>
<div class="line">pPlayer-&gt;play(fVisualTracking, 0, pInteractor);</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Overview</a></li>
    <li class="footer">Generated on Sat Apr 30 2016 17:16:16 for Lomse library. API documentation by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
