<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Lomse library API documentation: How Lomse playback works</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo-50x67.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Lomse library API documentation
   &#160;<span id="projectnumber">0.17.20</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Overview</span></a></li>
      <li class="current"><a href="pages.html"><span>Topics</span></a></li>
      <li><a href="modules.html"><span>Types&#160;and&#160;constants</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('sound-generation.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">How Lomse playback works </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Lomse provides class ScorePlayer, that takes care of most of the work to do. By using it, playing an score is, basically, three tasks:</p>
<ul>
<li>Load the score to play in the ScorePlayer instance.</li>
<li>Create a class, derived from PlayerGui for controling and defining the playback options (i.e. visual tracking, metronome settings, tempo speed, count-off, etc).</li>
<li>Ask ScorePlayer to play it, using the desired options.</li>
</ul>
<p>This is an excerpt of the needed code (more on it later):</p>
<div class="fragment"><div class="line"><span class="comment">//step 1: prepare for playing back the score</span></div>
<div class="line">ImoScore* pScore = ...</div>
<div class="line">ScorePlayer* pPlayer = ...</div>
<div class="line">PlayerGui* pPlayerGui = ...</div>
<div class="line">pPlayer-&gt;load_score(pScore, pPlayerGui);</div>
<div class="line"></div>
<div class="line"><span class="comment">//step2: go on</span></div>
<div class="line"><span class="keywordtype">bool</span> fVisualTracking = <span class="keyword">true</span>;</div>
<div class="line">m_pPlayer-&gt;play(fVisualTracking, 0, spInteractor.get());</div>
</div><!-- fragment --><p>PlayerGui is an interface between your application playback GUI controls and the Lomse library. By "playback GUI controls" I am referring to things such as a button, a menu item, or a link to ask for playing back the score, check boxes for specifying playback options, such as "generate metronome clicks" or "start with count off clicks", a slider for specifying tempo speed, etc. The simplest way for specifying an option (i.e. tempo speed for playing back the score) would be to pass its value directly to Lomse when asking to play the score. But this approach has a drawback: the chosen values can not be changed by the user while the score is being played. Therefore, instead of passing Lomse the values for options, the idea is to have an interface between Lomse and your application, so that Lomse can ask your application for these values when needed. More on this later.</p>
<p>The last line of previous code is invocation of play method. It will trigger all the playback machinery. But <b>Lomse will not generate any sounds</b>. Sound generation is always responsibility of your application. What Lomse will do is to generate <em>sound</em> <em>events</em>. Therefore, for playback, your application has three main responsibilities:</p>
<ul>
<li>Create a class, derived from PlayerGui for defining the playback options.</li>
<li>Handle sound events</li>
<li>Generate sound for each sound event</li>
</ul>
<p>Tasks 2 and 3 are accomplished by creating, in your application, a class derived from MidiServerBase. This base class defines the interface for processing MIDI events. Your application has to define a derived class and implement the virtual methods. Your class will receive the sound events and will have the responsibility of generating the sounds. Lomse does not impose any restriction about sound generation other than low latency. Perhaps, the simpler method to generate sounds is to rely on the MIDI synthesizer of the PC sound card.</p>
<p>ScorePlayer constructor requires an instance of the MidiServer to use:</p>
<div class="fragment"><div class="line">MidiServer* pMidi = <span class="keyword">new</span> MidiServer();</div>
<div class="line">ScorePlayer* pPlayer = m_lomse-&gt;create_score_player(pMidi);</div>
</div><!-- fragment --><p>With this, all playback machinery is in place.</p>
<p>As to visual tracking effects (highlighting notes being played and/or displaying a vertical tempo line marking beats), Lomse will also post <em>score</em> <em>highlight</em> events, to be handled by your application. By handling them you will have full control, and your application can create whatever fancy visual tracking effects you would like.</p>
<p>Nevertheless, Lomse implements standard visual effects so you can delegate in Lomse for generating visual effects. In this case, your application will just receive <em>update</em> <em>view</em> events when the display should be updated, and all you have to do is to copy the already updated rendering bitmap onto the window. All the required code for updating the display is already included in code from tutorial 2.</p>
<p>Finally, for controlling playback some GUI controls (buttons, menu items, etc. to trigger start, stop, pause actions) are required. Lomse gives your application two options for this:</p>
<ul>
<li>The first one is to create your own play/pause/stop control mechanism. For instance, you could use menu items, buttons in the toolbar, etc. For linkinf these controls to Lomse you will have to define a class derived from PlayerGui. We will see how to do it later in this tutorial.</li>
<li>The other alternative is to display, embedded the document, near the score, a <em>player</em> <em>control</em> widget (the typical play/stop buttons, plus playback information that we see in many media players). Lomse has such control (class ScorePlayerCtrl) but this is an advanced topic that requires knowledge of Lomse controls and dynamic content creation. So, I will explain nothing about it in this tutorial.</li>
</ul>
<p>So, as you can see, implementing score playback is simple, and the only burden for your application is coding a MidiServer class for generating the sounds.</p>
<p>Before coding the necessary changes in MyCanvas it is necessary to create the ScorePlayer object. It should be a global object, accessible from any point at which it is necessary to play an score. In our simple example, I will put this object as member of MyFrame and will pass it to MyCanvas in the constructor. Therefore, I will change MyFrame declaration to define a member variable and a getter method:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>MyFrame: <span class="keyword">public</span> wxFrame</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">protected:</div>
<div class="line">    ...</div>
<div class="line">    <span class="comment">//sound related</span></div>
<div class="line">    ...</div>
<div class="line">    ScorePlayer* get_score_player();</div>
<div class="line"></div>
<div class="line">    ScorePlayer* m_pPlayer;</div>
<div class="line">    ...</div>
</div><!-- fragment --><p>In MyFrame constructor the new variable m_pPlayer is initialized to NULL, and the ScorePlayer creation is delayed until really needed:</p>
<div class="fragment"><div class="line">ScorePlayer* MyFrame::get_score_player()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!m_pPlayer)</div>
<div class="line">    {</div>
<div class="line">        MidiServer* pMidi = get_midi_server();</div>
<div class="line">        m_pPlayer = m_lomse.create_score_player(pMidi);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> m_pPlayer;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Finally, we modify MyCanvas definition for receiving the ScorePlayer object in constructor:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>MyCanvas : <span class="keyword">public</span> wxWindow</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    MyCanvas(wxFrame *frame, <a class="code" href="classLomseDoorway.html">LomseDoorway</a>&amp; lomse, ScorePlayer* pPlayer);</div>
<div class="line">    ...</div>
<div class="line">protected:</div>
<div class="line">    ...</div>
<div class="line">    <span class="comment">// for score playback</span></div>
<div class="line">    ScorePlayer* m_pPlayer;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">MyCanvas::MyCanvas(wxFrame *frame, <a class="code" href="classLomseDoorway.html">LomseDoorway</a>&amp; lomse, ScorePlayer* pPlayer)</div>
<div class="line">    : wxWindow(frame, wxID_ANY)</div>
<div class="line">    , m_lomse(lomse)</div>
<div class="line">    , m_pPresenter(NULL)</div>
<div class="line">    , m_buffer(NULL)</div>
<div class="line">    , m_pPlayer(pPlayer)</div>
<div class="line">    , m_view_needs_redraw(true)</div>
<div class="line">{</div>
<div class="line">}</div>
</div><!-- fragment --><p>And we modify the code for passing the ScorePlayer object when MyCanvas instances are created, in MyFrame constructor:</p>
<div class="fragment"><div class="line">MyFrame::MyFrame()</div>
<div class="line">    : wxFrame(NULL, wxID_ANY, _T(<span class="stringliteral">&quot;Lomse sample for wxWidgets&quot;</span>),</div>
<div class="line">              wxDefaultPosition, wxSize(850, 600))</div>
<div class="line">    , m_pMidi(NULL)</div>
<div class="line">    , m_pPlayer(NULL)</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">    <span class="comment">// create our one and only child -- it will take our entire client area</span></div>
<div class="line">    m_canvas = <span class="keyword">new</span> MyCanvas(<span class="keyword">this</span>, m_lomse, get_score_player());</div>
<div class="line">    ...</div>
</div><!-- fragment --><p>With this, we have finished with the modifications required for MyFrame. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Overview</a></li>
    <li class="footer">Generated on Thu Mar 10 2016 16:18:10 for Lomse library API documentation by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
